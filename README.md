
# Hybrid ML-Based Dynamic Stop-Loss System for ES Futures



##  Project Overview

This project implements a comprehensive, **Hybrid Machine Learning System** designed to address the challenges of static stop-loss and entry logic in 1-minute ES (S&P 500) futures trading. 

By leveraging **LightGBM**, **VectorBT**, and **Unsupervised Learning**, the system predicts dynamic stop-loss levels and adaptive trade entries based on real-time market regimes. It moves beyond fixed-rule trading by mathematically scoring entry confidence and adjusting risk management according to predicted volatility.

###  Key Objectives
- **Dynamic Risk Management:** Replace static stops with volatility-aware, ML-predicted stop-loss levels.
- **Regime Detection:** Classify market states (Low, Medium, High Volatility) using K-Means/HMM to adapt strategies.
- **Precision Entry:** Use classification models to score trade entry confidence.
- **Realistic Backtesting:** Utilize `vectorbt` for high-performance simulation including spread and slippage.

---

##  System Architecture

The solution is built on a modular pipeline:

1.  **Feature Engineering:** Generates 50+ technical indicators (RSI, MACD, ATR, Bollinger Bands) and microstructure features (Volume-price analysis).
2.  **Regime Detection:** * **K-Means / HMM:** Clusters market conditions to filter trade signals.
3.  **Predictive Modeling (LightGBM):**
    * **Regressor:** Predicts optimal Stop-Loss distance.
    * **Classifier:** Generates Trade Entry probabilities.
4.  **Execution Logic:**
    * **Position Sizing:** Dynamically adjusts contract size based on the predicted risk (stop-loss distance).
    * **Walk-Forward Validation:** Ensures the model is trained on past data to predict future data without look-ahead bias.

---

##  Folder Structure

```text
ML-Trading-System/
│
├── algorithm.py              # Main script (Entry, SL logic, Training, Backtesting)
├── requirements.txt          # Python dependencies
├── SP candles/               # Directory for 1-minute candle CSV files
│   └── SP500_data.csv        # Example data file
├── models/                   # (Optional) Saved LightGBM models
└── README.md                 # Project documentation
````

-----

##  Installation & Setup

### Prerequisites

  - Python \>= 3.9
  - pip package manager

### 1\. Environment Setup (Recommended)

It is highly recommended to use a virtual environment to avoid dependency conflicts.

**Windows:**

```bash
python -m venv myenv
.\myenv\Scripts\activate
```

**Mac/Linux:**

```bash
python3 -m venv myenv
source myenv/bin/activate
```

### 2\. Install Dependencies

```bash
pip install -r requirements.txt
```

*Note: Optional dependencies for advanced visualization include `dash`, `plotly`, and `ib_insync`.*

-----

##  How to Run

1.  **Prepare Data:**
    Place your 1-minute ES Futures candle data (CSV format) inside the `SP candles/` folder.

      * *Required Columns:* Date, Open, High, Low, Close, Volume.

2.  **Execute the Algorithm:**
    Run the main script to process data, train models, and backtest.

    ```bash
    python algorithm.py
    ```

3.  **Review Output:**
    The script will output performance metrics to the console and generating prediction logs.

-----

##  Sample Performance Output

The following represents typical backtest results generated by the system:

```text
--- Backtest Results ---
Sharpe Ratio:     1.32
Total Return:     14.87%
Max Drawdown:     -5.21%
Win Rate:         63.45%

--- Latest Candle Predictions ---
Predicted SL Distance:    2.85 pts
Entry Signal Prob:        68.21%
Recommended Contracts:    4
```

-----

##  Configuration & Customization

You can adjust the following parameters inside `algorithm.py`:

  * **`initial_capital`**: Starting portfolio value (default: $100,000).
  * **`risk_budget`**: Percentage of capital at risk per trade (e.g., 0.02 for 2%).
  * **`retrain_frequency`**: How often the ML model retrains (e.g., every 100 bars).
  * **`regime_thresholds`**: Volatility cut-offs for Low/High regime detection.

**Optimization Note:** To improve model performance, consider increasing `n_trials` in the Optuna hyperparameter tuning section of the code.

-----

##  Repository Info

  * **GitHub:** [Hybrid-ML-Based-Dynamic-Loss-Approach](https://github.com/shehab0911/Hybrid-ML-Based-Dynamic-Loss-Approach)
  * **Author:** Shehab

-----

```
```

